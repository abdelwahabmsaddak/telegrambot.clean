async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.strip()
    lang = detect_lang(text)

    # ========= ANALYSIS BUTTON =========
    if text in ["ğŸ“Š Analysis", "ØªØ­Ù„ÙŠÙ„"]:
        await update.message.reply_text(
            "ğŸ“Š Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ù…Ø²:\nBTC / ETH / XAUUSD / TSLA"
        )
        context.user_data["mode"] = "analysis"
        return

    # ========= SYMBOL ANALYSIS =========
    if context.user_data.get("mode") == "analysis":
        symbol = text.upper()

        if symbol not in VALID_SYMBOLS:
            await update.message.reply_text(
                "âŒ Ø±Ù…Ø² ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.\nØ§Ø³ØªØ®Ø¯Ù…: BTC / ETH / XAUUSD / TSLA"
                if lang == "ar"
                else
                "âŒ Unknown symbol. Use: BTC / ETH / XAUUSD / TSLA"
            )
            return

        # ğŸ”¥ ØªØ­Ù„ÙŠÙ„ Ø¨Ø¯ÙˆÙ† AI (Ù…Ø¶Ù…ÙˆÙ†)
        await update.message.reply_text(
            f"ğŸ“Š ØªØ­Ù„ÙŠÙ„ {symbol}\n\n"
            f"- Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ø§Ù…: ØµØ§Ø¹Ø¯ / Ø¹Ø±Ø¶ÙŠ\n"
            f"- Ø¯Ø¹Ù… Ù…Ù‡Ù…: Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«\n"
            f"- Ù…Ù‚Ø§ÙˆÙ…Ø©: Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«\n\n"
            f"âš ï¸ ØªØ­Ù„ÙŠÙ„ ØªØ¹Ù„ÙŠÙ…ÙŠ ÙÙ‚Ø·"
        )
        context.user_data["mode"] = None
        return

    # ========= CHAT MODE =========
    if text in ["ğŸ’¬ Chat", "Ø¯Ø±Ø¯Ø´Ø©"]:
        context.user_data["mode"] = "chat"
        await update.message.reply_text(
            "ğŸ’¬ ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ÙØ¹Ù„"
            if lang == "ar"
            else
            "ğŸ’¬ Chat mode enabled"
        )
        return

    if context.user_data.get("mode") == "chat":
        try:
            await update.message.reply_text(ai_answer(text, lang))
        except:
            await update.message.reply_text(
                "âŒ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹"
                if lang == "ar"
                else
                "âŒ AI temporarily unavailable"
            )
        return
